topdir=../

include $(topdir)makefile.inc

CFLAGS+=$(CTHUMB)

# warning: library order matters!
LDLIBS= -lgcc
LDOPTS=-nostdlib -Wl,--allow-shlib-undefined -Wl,-T,$(topdir)tools/link-boot.ld
LDOPTS+=-Wl,-N,-Ttext,$(MEMISOSTART)

SUBDIRS=modules

all: main.bin

# Core CHDK flag
CFLAGS+=-DTHIS_IS_CHDK_CORE

OPT_OBJS=
ifdef OPT_GAMES
CFLAGS+=-DOPT_GAMES
endif
ifdef OPT_CURVES
CFLAGS+=-DOPT_CURVES
endif
ifdef OPT_TEXTREADER
CFLAGS+=-DOPT_TEXTREADER
endif
ifdef OPT_CALENDAR
CFLAGS+=-DOPT_CALENDAR
endif
ifdef OPT_DEBUGGING
# global in root makefile.inc
#CFLAGS+=-DOPT_DEBUGGING
#OPT_OBJS+=gui_debug.o gui_bench.o 
endif
ifdef OPT_EDGEOVERLAY
CFLAGS+=-DOPT_EDGEOVERLAY
#OPT_OBJS+=edgeoverlay.o 
endif
ifdef OPT_MD_DEBUG
CFLAGS+=-DOPT_MD_DEBUG
endif 
ifdef OPT_SCRIPTING
OPT_OBJS+=script.o
endif 
ifdef OPT_LUA
OPT_OBJS+=luascript.o 
endif 
ifdef OPT_LUA_CALL_NATIVE
CFLAGS+=-DOPT_LUA_CALL_NATIVE
endif
ifdef OPT_PTP
# in top level
#CFLAGS+=-DOPT_PTP
OPT_OBJS+=ptp.o 
endif
ifdef OPT_EXMEM_MALLOC
#CFLAGS+=-DOPT_EXMEM_MALLOC
OPT_OBJS+=suba.o
endif

OBJS=entry.o main.o gui_draw.o gui_menu.o gui_user_menu.o gui_mbox.o \
     gui.o kbd.o action_stack.o conf.o module_wrappers.o module_exportlist.o \
     histogram.o gui_batt.o gui_usb.o gui_space.o gui_osd.o raw.o \
     gui_lang.o modules.o module_load.o \
     levent.o shot_histogram.o console.o shooting.o \
     usb_input.o usb_module.o usb_remote.o $(OPT_OBJS)

gui.o: FORCE

FORCE:

nothumb.o: nothumb.c
	@echo $< \-\> $@
	$(CC) $(CFLAGS) -marm -nostdinc -c -o $@ $<

main.bin: main.elf
	@echo $< \-\> $@
	$(OBJDUMP) -z -d main.elf > main.dump
	$(OBJCOPY) -O binary main.elf main.bin

main.elf: $(OBJS) $(topdir)platform/$(PLATFORM)/libplatform.a \
          $(topdir)platform/$(PLATFORM)/sub/$(PLATFORMSUB)/libplatformsub.a \
          $(topdir)lib/font/libfont.a $(topdir)lib/math/libmath.a \
          $(topdir)lib/ubasic/libubasic.a $(topdir)lib/lang/liblang.a \
          $(topdir)lib/lua/liblua.a \
          $(topdir)lib/armutil/libarmutil.a
	@echo \-\> $@
	$(CC) $(CFLAGS) -o $@ -Wl,--start-group $^  $(LDLIBS) -Wl,--end-group $(LDFLAGS) $(LDOPTS)
	( $(NM) $@ | grep ' U ' > $@.syms ) && echo "error: unresolved symbols in $@ (see $@.syms)" && exit 1 || exit 0

	$(SIZE) $@ | tee $(topdir)size.txt
	@printf " %s-%s (%s, #%s): MEMISOSIZE used: 0x%s\n" \
   $(PLATFORM) $(PLATFORMSUB) $(PLATFORMOS) $(PLATFORMID) \
   `tail -c16 $(topdir)size.txt | head -c6` >> $(topdir)bin/caminfo.txt
	rm -f $(topdir)size.txt

clean:
	rm -f $(OBJS) main.bin main.elf main.dump main.elf.syms

distclean: clean
	rm -f $(OBJS:.o=.d)

module_load.o: module_load.c module_load.h module_exportlist.c module_exportlist.h flt.h

module_exportlist.h: $(topdir)tools/makeexport$(EXE) module_exportlist.c
	@echo $< \-\> $@
	$(topdir)tools/makeexport$(EXE) module_exportlist.c module_exportlist.h modules/exportlist.txt module_hashlist.h

flt.h: $(topdir)tools/elf2flt/flt.h
	@echo $< \-\> $@
	@echo "//DO NOT EDIT THIS FILE. This is automatic copy of tools/elf2flt/flt.h" > flt.h
	cat $(topdir)tools/elf2flt/flt.h >>flt.h

gui_lang.o: gui_lang.c gui_lang.h gui_lang_str.h

ifdef OPT_DEFAULT_LANG
gui_lang_str.h: $(topdir)tools/makelang$(EXE) $(topdir)CHDK/LANG/english.lng $(topdir)CHDK/LANG/$(OPT_DEFAULT_LANG).lng
	@echo $< \-\> $@
	$(topdir)tools/makelang$(EXE) $(topdir)CHDK/LANG/english.lng $(topdir)CHDK/LANG/$(OPT_DEFAULT_LANG).lng > gui_lang_str.h
else
gui_lang_str.h: $(topdir)tools/makelang$(EXE) $(topdir)CHDK/LANG/english.lng
	@echo $< \-\> $@
	$(topdir)tools/makelang$(EXE) $(topdir)CHDK/LANG/english.lng > gui_lang_str.h
endif

include $(topdir)bottom.inc
